# Change Detection: Visual Summary

## The Simple Answer

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Sanity tracks changes automatically via _updatedAt        â”‚
â”‚  Script saves "last run" timestamp                          â”‚
â”‚  Next run: "Give me docs newer than last run"              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Step-by-Step Flow

```
Step 1: First Run (Monday 10:00 AM)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Script     â”‚      â”‚   Sanity     â”‚      â”‚   Disk       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ No timestamp â”‚â”€â”€â”€â”€â”€â†’â”‚ Fetch ALL    â”‚      â”‚              â”‚
â”‚ file exists  â”‚      â”‚ documents    â”‚      â”‚              â”‚
â”‚              â”‚â†â”€â”€â”€â”€â”€â”‚ 500 docs     â”‚      â”‚              â”‚
â”‚              â”‚      â”‚              â”‚      â”‚              â”‚
â”‚ Generate     â”‚      â”‚              â”‚      â”‚              â”‚
â”‚ all TTLs     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚ Write all    â”‚
â”‚              â”‚      â”‚              â”‚      â”‚ .ttl files   â”‚
â”‚              â”‚      â”‚              â”‚      â”‚              â”‚
â”‚ Save time:   â”‚      â”‚              â”‚      â”‚              â”‚
â”‚ 10:00:00Z    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚ .last-run-   â”‚
â”‚              â”‚      â”‚              â”‚      â”‚  timestamp   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


Step 2: Author Makes Change (Monday 11:30 AM)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Author     â”‚      â”‚   Sanity (auto-updates)         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Edit         â”‚      â”‚ BEFORE:                         â”‚
â”‚ "Biomechanics"â”€â”€â”€â”€â”€â”€â†’ _id: "...biomechanics"         â”‚
â”‚              â”‚      â”‚ _updatedAt: "10:00:00Z"         â”‚
â”‚ Click Save   â”‚      â”‚ prefLabel: "Biomechanics"       â”‚
â”‚              â”‚      â”‚                                  â”‚
â”‚              â”‚      â”‚ AFTER:                           â”‚
â”‚              â”‚      â”‚ _id: "...biomechanics"          â”‚
â”‚              â”‚      â”‚ _updatedAt: "11:30:00Z" â† AUTO! â”‚
â”‚              â”‚      â”‚ prefLabel: "Biomechanics..."    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


Step 3: Second Run (Monday 2:00 PM)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Script     â”‚      â”‚   Sanity     â”‚      â”‚   Disk       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Read         â”‚      â”‚              â”‚      â”‚              â”‚
â”‚ .last-run-   â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ "10:00:00Z"  â”‚
â”‚ timestamp    â”‚      â”‚              â”‚      â”‚              â”‚
â”‚              â”‚      â”‚              â”‚      â”‚              â”‚
â”‚ Query:       â”‚      â”‚              â”‚      â”‚              â”‚
â”‚ "Give me     â”‚â”€â”€â”€â”€â”€â†’â”‚ Filter by    â”‚      â”‚              â”‚
â”‚ docs newer   â”‚      â”‚ timestamp    â”‚      â”‚              â”‚
â”‚ than 10:00"  â”‚      â”‚              â”‚      â”‚              â”‚
â”‚              â”‚â†â”€â”€â”€â”€â”€â”‚ Returns:     â”‚      â”‚              â”‚
â”‚              â”‚      â”‚ 1 doc        â”‚      â”‚              â”‚
â”‚              â”‚      â”‚ (Biomechanics)     â”‚              â”‚
â”‚              â”‚      â”‚              â”‚      â”‚              â”‚
â”‚ Regenerate   â”‚      â”‚              â”‚      â”‚              â”‚
â”‚ science-     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚ Update only  â”‚
â”‚ knowledge-   â”‚      â”‚              â”‚      â”‚ science-     â”‚
â”‚ taxonomy.ttl â”‚      â”‚              â”‚      â”‚ *.ttl        â”‚
â”‚              â”‚      â”‚              â”‚      â”‚              â”‚
â”‚ Save time:   â”‚      â”‚              â”‚      â”‚              â”‚
â”‚ 14:00:00Z    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚ Update       â”‚
â”‚              â”‚      â”‚              â”‚      â”‚ timestamp    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


Step 4: Third Run - No Changes (Monday 2:30 PM)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Script     â”‚      â”‚   Sanity     â”‚      â”‚   Disk       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Read         â”‚      â”‚              â”‚      â”‚              â”‚
â”‚ timestamp:   â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ "14:00:00Z"  â”‚
â”‚ 14:00:00Z    â”‚      â”‚              â”‚      â”‚              â”‚
â”‚              â”‚      â”‚              â”‚      â”‚              â”‚
â”‚ Query:       â”‚      â”‚              â”‚      â”‚              â”‚
â”‚ "Newer than  â”‚â”€â”€â”€â”€â”€â†’â”‚ Filter...    â”‚      â”‚              â”‚
â”‚ 14:00:00Z?"  â”‚      â”‚              â”‚      â”‚              â”‚
â”‚              â”‚â†â”€â”€â”€â”€â”€â”‚ Returns:     â”‚      â”‚              â”‚
â”‚              â”‚      â”‚ 0 docs       â”‚      â”‚              â”‚
â”‚              â”‚      â”‚ (nothing new)â”‚      â”‚              â”‚
â”‚              â”‚      â”‚              â”‚      â”‚              â”‚
â”‚ Nothing to   â”‚      â”‚              â”‚      â”‚              â”‚
â”‚ do!          â”‚      â”‚              â”‚      â”‚              â”‚
â”‚              â”‚      â”‚              â”‚      â”‚              â”‚
â”‚ Still save   â”‚      â”‚              â”‚      â”‚              â”‚
â”‚ timestamp:   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚ "14:30:00Z"  â”‚
â”‚ 14:30:00Z    â”‚      â”‚              â”‚      â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## The Key: Sanity's _updatedAt Field

Every document has this automatically:

```json
{
  "_id": "content-descriptor-biomechanics",
  "_type": "contentDescriptor",
  "_createdAt": "2025-12-01T10:00:00Z",    â† Created (never changes)
  "_updatedAt": "2025-12-20T11:30:00Z",    â† Last modified (auto-updates)
  "_rev": "v6-abc123",                      â† Revision (auto-increments)

  "prefLabel": "Biomechanics",
  "substrand": { "_ref": "substrand-..." }
}
```

**Sanity updates `_updatedAt` when:**
- Field is edited
- Reference is changed
- Array is modified
- Document is published
- Document is unpublished

**You don't manage this - Sanity does it automatically!**

## The Query: Time-Filtered Fetch

### Without Incremental (Full Sync)

```javascript
// GROQ query
*[_type == "contentDescriptor"]

// Returns ALL 500 descriptors
// Takes 5 seconds
// 2 MB download
```

### With Incremental (Time Filter)

```javascript
// GROQ query with time filter
*[_type == "contentDescriptor" && _updatedAt > "2025-12-20T10:00:00Z"]
                                 â†‘
                                 Only newer than this!

// Returns 2 descriptors (only what changed)
// Takes 0.5 seconds
// 8 KB download
```

## Comparison: What Gets Fetched

```
Full Sync:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Sanity Database (500 documents)        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Doc A  â”‚ Doc B  â”‚ Doc C  â”‚ Doc D  â”‚  â”‚
â”‚  â”‚10:00 AMâ”‚10:00 AMâ”‚10:00 AMâ”‚10:00 AMâ”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚          ALL FETCHED                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“ â†“ â†“ â†“
    500 documents downloaded


Incremental Sync (last run: 10:00 AM):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Sanity Database (500 documents)        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Doc A  â”‚ Doc B  â”‚ Doc C  â”‚ Doc D  â”‚  â”‚
â”‚  â”‚10:00 AMâ”‚11:30 AMâ”‚10:00 AMâ”‚11:45 AMâ”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚     âœ—       âœ“        âœ—        âœ“         â”‚
â”‚   (old)   (new!)   (old)   (new!)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“          â†“
      2 documents downloaded
```

## The Timestamp File

```
scripts/.last-run-timestamp
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

2025-12-20T14:00:00Z
```

**This is the "memory" of when we last ran successfully.**

On each run:
1. Read this file â†’ "10:00:00Z"
2. Query Sanity â†’ "newer than 10:00:00Z?"
3. Get changed docs
4. Generate TTL files
5. Write new time â†’ "14:00:00Z"

## What If...?

### Q: What if script crashes before saving timestamp?

**A: Safe! Changes get refetched next run.**

```
10:00 AM - Run successful (timestamp saved)
11:00 AM - Author edits
12:00 PM - Script fetches changes, crashes before saving
01:00 PM - Script runs again, still sees 10:00 AM timestamp
           Fetches 11:00 AM change again (safe duplication)
```

### Q: What if document is deleted?

**A: Not detected by time filter (document is gone).**

```javascript
// Query for changes
*[_type == "contentDescriptor" && _updatedAt > "..."]

// Deleted documents don't exist to be returned!
```

**Solution: Periodic full sync to catch deletions**

```bash
# Mon-Sat: Incremental (fast)
python sanity_to_ttl.py --api --incremental

# Sunday: Full sync (catches deletions)
python sanity_to_ttl.py --api --subjects all
```

### Q: What if Sanity clock is different from my server?

**A: Add time buffer**

```python
# Subtract 5 seconds when saving timestamp
timestamp = (datetime.now(utc) - timedelta(seconds=5))

# Ensures we don't miss changes due to clock skew
```

## Summary in One Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    How It Works                          â”‚
â”‚                                                           â”‚
â”‚  1. Sanity tracks: _updatedAt (automatic)               â”‚
â”‚  2. Script saves: .last-run-timestamp                   â”‚
â”‚  3. Script queries: "newer than timestamp?"             â”‚
â”‚  4. Sanity returns: only changed documents              â”‚
â”‚  5. Script regenerates: only affected TTL files         â”‚
â”‚  6. Script saves: new timestamp for next run            â”‚
â”‚                                                           â”‚
â”‚  Result: Only process what actually changed!            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**No complex tracking needed - Sanity does it all!** ğŸ‰

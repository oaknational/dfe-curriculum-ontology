name: Deploy Fuseki to Cloud Run

on:
  release:
    types: [ published ]
  workflow_dispatch:  # Allow manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Verify authentication
        run: |
          echo "Authenticated service account:"
          gcloud auth list --filter=status:ACTIVE --format="value(account)"
          echo ""
          echo "Expected: github-actions-deployer@oak-ai-playground.iam.gserviceaccount.com"

      - name: Configure Docker for GCR
        run: gcloud auth configure-docker gcr.io

      - name: Build Docker image
        run: |
          docker build \
            -t gcr.io/${{ secrets.GCP_PROJECT_ID }}/national-curriculum-for-england-fuseki:${{ github.sha }} \
            -t gcr.io/${{ secrets.GCP_PROJECT_ID }}/national-curriculum-for-england-fuseki:latest \
            -f deployment/Dockerfile \
            .

      - name: Push Docker image
        run: |
          docker push gcr.io/${{ secrets.GCP_PROJECT_ID }}/national-curriculum-for-england-fuseki:${{ github.sha }}
          docker push gcr.io/${{ secrets.GCP_PROJECT_ID }}/national-curriculum-for-england-fuseki:latest

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy national-curriculum-for-england-sparql \
            --image=gcr.io/${{ secrets.GCP_PROJECT_ID }}/national-curriculum-for-england-fuseki:${{ github.sha }} \
            --platform=managed \
            --region=europe-west1 \
            --allow-unauthenticated \
            --port=3030 \
            --memory=2Gi \
            --cpu=2 \
            --max-instances=10 \
            --timeout=300 \
            --concurrency=80

      - name: Get service URL
        id: service-url
        run: |
          URL=$(gcloud run services describe national-curriculum-for-england-sparql \
            --region=europe-west1 \
            --format='value(status.url)')
          echo "url=$URL" >> $GITHUB_OUTPUT

      - name: Test deployment
        id: test-deployment
        run: |
          URL="${{ steps.service-url.outputs.url }}"
          echo "Testing deployment at $URL..."

          # Wait for service to be ready
          sleep 10

          # Test health endpoint
          curl -f ${URL}/$/ping || exit 1

          # Test SPARQL query
          COUNT=$(curl -s -X POST \
            -H "Content-Type: application/sparql-query" \
            -H "Accept: application/json" \
            --data "SELECT (COUNT(*) as ?count) WHERE { ?s ?p ?o }" \
            ${URL}/national-curriculum-for-england/sparql | jq -r '.results.bindings[0].count.value')

          echo "Triple count: $COUNT"
          echo "triple_count=$COUNT" >> $GITHUB_OUTPUT

          if [ "$COUNT" -gt "0" ]; then
            echo "✅ Deployment test passed!"
          else
            echo "❌ Deployment test failed - no triples found"
            exit 1
          fi

      - name: Display deployment summary
        if: always()
        run: |
          echo "### Fuseki SPARQL Endpoint Deployed to Cloud Run" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Service:** national-curriculum-for-england-sparql" >> $GITHUB_STEP_SUMMARY
          echo "**Region:** europe-west1 (Belgium)" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** gcr.io/${{ secrets.GCP_PROJECT_ID }}/national-curriculum-for-england-fuseki:${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.test-deployment.outcome }}" == "success" ]; then
            echo "✅ **Status:** Deployed and tested successfully" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "#### Endpoints" >> $GITHUB_STEP_SUMMARY
            echo "- **SPARQL Query:** ${{ steps.service-url.outputs.url }}/national-curriculum-for-england/sparql" >> $GITHUB_STEP_SUMMARY
            echo "- **Health Check:** ${{ steps.service-url.outputs.url }}/$/ping" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "#### Test Results" >> $GITHUB_STEP_SUMMARY
            echo "- Health check: ✅ Passed" >> $GITHUB_STEP_SUMMARY
            echo "- SPARQL query: ✅ Passed" >> $GITHUB_STEP_SUMMARY
            echo "- Triple count: **${{ steps.test-deployment.outputs.triple_count }}**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "#### Configuration" >> $GITHUB_STEP_SUMMARY
            echo "- Memory: 2Gi" >> $GITHUB_STEP_SUMMARY
            echo "- CPU: 2" >> $GITHUB_STEP_SUMMARY
            echo "- Max instances: 10" >> $GITHUB_STEP_SUMMARY
            echo "- Timeout: 300s" >> $GITHUB_STEP_SUMMARY
            echo "- Concurrency: 80" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **Status:** Deployment failed or tests did not pass" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please review the logs above for error details." >> $GITHUB_STEP_SUMMARY
          fi

@prefix curric: <https://w3id.org/uk/curriculum/core/> .
@prefix curricshapes: <https://w3id.org/uk/curriculum/core/shapes/> .
@prefix sh: <http://www.w3.org/ns/shacl#> .
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix owl: <http://www.w3.org/2002/07/owl#> .
@prefix skos: <http://www.w3.org/2004/02/skos/core#> .
@prefix dc: <http://purl.org/dc/elements/1.1/> .
@prefix dcterms: <http://purl.org/dc/terms/> .
@prefix vann: <http://purl.org/vocab/vann/> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .

# ======================================================================
# DfE Curriculum Ontology - SHACL Constraints 
# ======================================================================

# ----------------------------------------------------------------------
# Ontology Declaration
# ----------------------------------------------------------------------

<https://w3id.org/uk/curriculum/core/shapes>
  rdf:type owl:Ontology ;

  rdfs:label "DfE Curriculum Ontology - SHACL Constraints"@en ;
  dc:title "DfE Curriculum Ontology - SHACL Constraints"@en ;
  rdfs:comment "SHACL validation constraints for DfE Curriculum Ontology."@en ;

  owl:versionInfo "0.1.0" ;
  owl:versionIRI <https://w3id.org/uk/curriculum/core/shapes/0.1.0> ;
  owl:priorVersion <https://w3id.org/uk/curriculum/core/shapes/0.0.9> ;
  
  dcterms:description """These SHACL constraints represent current rules and policies that may 
  evolve over time, separate from the core ontology definitions."""@en ;
  dcterms:creator "Department for Education" ;
  dcterms:created "2025-12-01"^^xsd:date ; 
  dcterms:modified "2025-12-01"^^xsd:date ;
  dcterms:issued "2025-12-01"^^xsd:date ;
  
  dcterms:license <http://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/> ;
  dcterms:rights "Crown Copyright"@en ;
  
  rdfs:seeAlso <https://www.gov.uk/government/collections/national-curriculum> ;
  vann:preferredNamespacePrefix "curricshapes" ;
  vann:preferredNamespaceUri "https://w3id.org/uk/curriculum/core/shapes/" .

# ----------------------------------------------------------------------
# Changelog
# ----------------------------------------------------------------------

curricshapes:version-0.1.0
  dcterms:date "2025-12-03"^^xsd:date ;
  rdfs:comment "Initial release"@en .

curricshapes:version-0.0.9
  dcterms:date "2025-11-19"^^xsd:date ;
  rdfs:comment "Development version"@en .

# ----------------------------------------------------------------------
# Shape: Phase
# ----------------------------------------------------------------------

curricshapes:PhaseShape
  a sh:NodeShape ;
  sh:targetClass curric:Phase ;

  sh:property [
    sh:path rdfs:label ;
    sh:datatype rdf:langString ;
    sh:minCount 1 ;
    sh:maxCount 1 ;
    sh:name "label" ;
    sh:description "Every phase must have exactly one rdfs:label." ;
    sh:message "Phases must have exactly one rdfs:label." ;
  ] ;

  sh:property [
    sh:path curric:lowerAgeBoundary ;
    sh:datatype xsd:nonNegativeInteger ;
    sh:minCount 1 ;
    sh:maxCount 1 ;
    sh:name "lower age boundary" ;
    sh:description "A phase must have exactly one lower age boundary." ;
    sh:message "Every phase must specify exactly one lower age boundary." ;
  ] ;

  sh:property [
    sh:path curric:upperAgeBoundary ;
    sh:datatype xsd:positiveInteger ;
    sh:minCount 1 ;
    sh:maxCount 1 ;
    sh:name "upper age boundary" ;
    sh:description "A phase must have exactly one upper age boundary." ;
    sh:message "Every phase must specify exactly one upper age boundary." ;
  ] ;

  sh:sparql [
    sh:message "Lower age boundary must be less than upper age boundary" ;
    sh:select """
      PREFIX curric: <https://w3id.org/uk/curriculum/core/>
      SELECT $this WHERE {
        $this curric:lowerAgeBoundary ?lower ;
              curric:upperAgeBoundary ?upper .
        FILTER (?lower >= ?upper)
      }
    """ ;
  ] ;

  sh:sparql [
    sh:message "Age boundaries must be in reasonable range (0-25 years)" ;
    sh:select """
      PREFIX curric: <https://w3id.org/uk/curriculum/core/>
      SELECT $this WHERE {
        $this curric:lowerAgeBoundary ?lower ;
              curric:upperAgeBoundary ?upper .
        FILTER (?lower < 0 || ?upper > 25)
      }
    """ ;
  ] .

# ----------------------------------------------------------------------
# Shape: KeyStage
# ----------------------------------------------------------------------

curricshapes:KeyStageShape
  a sh:NodeShape ;
  sh:targetClass curric:KeyStage ;

  sh:property [
    sh:path rdfs:label ;
    sh:datatype rdf:langString ;
    sh:minCount 1 ;
    sh:maxCount 1 ;
    sh:name "label" ;
    sh:description "Every key stage must have exactly one rdfs:label." ;
    sh:message "Key stages must have exactly one rdfs:label." ;
  ] ;

  sh:property [
    sh:path curric:isPartOf ;
    sh:class curric:Phase ;
    sh:minCount 1 ;
    sh:maxCount 1 ;
    sh:name "is part of" ;
    sh:description "Every key stage must be part of exactly one phase." ;
    sh:message "Key stages must specify which phase they belong to." ;
  ] ;

  sh:property [
    sh:path curric:lowerAgeBoundary ;
    sh:datatype xsd:nonNegativeInteger ;
    sh:minCount 1 ;
    sh:maxCount 1 ;
    sh:name "lower age boundary" ;
    sh:description "A key stage must have exactly one lower age boundary." ;
    sh:message "Every key stage must specify exactly one lower age boundary." ;
  ] ;

  sh:property [
    sh:path curric:upperAgeBoundary ;
    sh:datatype xsd:positiveInteger ;
    sh:minCount 1 ;
    sh:maxCount 1 ;
    sh:name "upper age boundary" ;
    sh:description "A key stage must have exactly one upper age boundary." ;
    sh:message "Every key stage must specify exactly one upper age boundary." ;
  ] ;

  sh:sparql [
    sh:message "Lower age boundary must be less than upper age boundary" ;
    sh:select """
      PREFIX curric: <https://w3id.org/uk/curriculum/core/>
      SELECT $this WHERE {
        $this curric:lowerAgeBoundary ?lower ;
              curric:upperAgeBoundary ?upper .
        FILTER (?lower >= ?upper)
      }
    """ ;
  ] ;

  sh:sparql [
    sh:message "Key stage age boundaries must fall within parent phase boundaries" ;
    sh:select """
      PREFIX curric: <https://w3id.org/uk/curriculum/core/>
      SELECT $this WHERE {
        $this curric:isPartOf ?phase ;
              curric:lowerAgeBoundary ?childLower ;
              curric:upperAgeBoundary ?childUpper .
        
        ?phase curric:lowerAgeBoundary ?parentLower ;
               curric:upperAgeBoundary ?parentUpper .
        
        FILTER (?childLower < ?parentLower || ?childUpper > ?parentUpper)
      }
    """ ;
  ] .

# ----------------------------------------------------------------------
# Shape: YearGroup
# ----------------------------------------------------------------------

curricshapes:YearGroupShape
  a sh:NodeShape ;
  sh:targetClass curric:YearGroup ;

  sh:property [
    sh:path rdfs:label ;
    sh:datatype rdf:langString ;
    sh:minCount 1 ;
    sh:maxCount 1 ;
    sh:name "label" ;
    sh:description "Every year group must have exactly one rdfs:label." ;
    sh:message "Year groups must have exactly one rdfs:label." ;
  ] ;

  sh:property [
    sh:path curric:isPartOf ;
    sh:class curric:KeyStage ;
    sh:minCount 1 ;
    sh:maxCount 1 ;
    sh:name "is part of" ;
    sh:description "Every year group must be part of exactly one key stage." ;
    sh:message "Year groups must specify which key stage they belong to." ;
  ] ;

  sh:property [
    sh:path curric:lowerAgeBoundary ;
    sh:datatype xsd:nonNegativeInteger ;
    sh:minCount 1 ;
    sh:maxCount 1 ;
    sh:name "lower age boundary" ;
    sh:description "A year group must have exactly one lower age boundary." ;
    sh:message "Every year group must specify exactly one lower age boundary." ;
  ] ;

  sh:property [
    sh:path curric:upperAgeBoundary ;
    sh:datatype xsd:positiveInteger ;
    sh:minCount 1 ;
    sh:maxCount 1 ;
    sh:name "upper age boundary" ;
    sh:description "A year group must have exactly one upper age boundary." ;
    sh:message "Every year group must specify exactly one upper age boundary." ;
  ] ;

  sh:sparql [
    sh:message "Lower age boundary must be less than upper age boundary" ;
    sh:select """
      PREFIX curric: <https://w3id.org/uk/curriculum/core/>
      SELECT $this WHERE {
        $this curric:lowerAgeBoundary ?lower ;
              curric:upperAgeBoundary ?upper .
        FILTER (?lower >= ?upper)
      }
    """ ;
  ] ;

  sh:sparql [
    sh:message "Year group age boundaries must fall within parent key stage boundaries" ;
    sh:select """
      PREFIX curric: <https://w3id.org/uk/curriculum/core/>
      SELECT $this WHERE {
        $this curric:isPartOf ?keystage ;
              curric:lowerAgeBoundary ?childLower ;
              curric:upperAgeBoundary ?childUpper .
        
        ?keystage curric:lowerAgeBoundary ?parentLower ;
                  curric:upperAgeBoundary ?parentUpper .
        
        FILTER (?childLower < ?parentLower || ?childUpper > ?parentUpper)
      }
    """ ;
  ] .

# ----------------------------------------------------------------------
# Shape: Subject
# ----------------------------------------------------------------------

curricshapes:SubjectShape
  a sh:NodeShape ;
  sh:targetClass curric:Subject ;

  sh:property [
    sh:path rdfs:label ;
    sh:datatype rdf:langString ;
    sh:minCount 1 ;
    sh:maxCount 1 ;
    sh:name "label" ;
    sh:description "Every subject must have exactly one rdfs:label." ;
    sh:message "Subjects must have exactly one rdfs:label." ;
  ] ;

  sh:property [
    sh:path curric:hasDiscipline ;
    sh:class curric:Discipline ;
    sh:minCount 1 ;
    sh:maxCount 1 ;
    sh:name "has discipline" ;
    sh:description "Every subject must relate to exactly one discipline." ;
    sh:message "Subjects must specify which disciplines they relate to." ;
  ] ;

  sh:sparql [
    sh:message "Subject label must match its discipline's preferred label" ;
    sh:select """
      PREFIX curric: <https://w3id.org/uk/curriculum/core/>
      PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
      PREFIX skos: <http://www.w3.org/2004/02/skos/core#>
      
      SELECT $this WHERE {
        $this a curric:Subject ;
              curric:hasDiscipline ?discipline ;
              rdfs:label ?subjectLabel .
        
        ?discipline skos:prefLabel ?disciplineLabel .
        
        FILTER (?subjectLabel != ?disciplineLabel)
      }
    """ ;
  ] ;

  sh:sparql [
    sh:severity sh:Warning ;
    sh:message "Subject is not used in any sub-subject (WARNING - orphaned)" ;
    sh:select """
      PREFIX curric: <https://w3id.org/uk/curriculum/core/>
      SELECT $this WHERE {
        $this a curric:Subject .
        FILTER NOT EXISTS {
          ?subsubject a curric:SubSubject ;
                      curric:isPartOf $this .
        }
      }
    """ ;
  ] .

# ----------------------------------------------------------------------
# Shape: SubSubject
# ----------------------------------------------------------------------

curricshapes:SubSubjectShape
  a sh:NodeShape ;
  sh:targetClass curric:SubSubject ;

  sh:property [
    sh:path rdfs:label ;
    sh:datatype rdf:langString ;
    sh:minCount 1 ;
    sh:maxCount 1 ;
    sh:name "label" ;
    sh:description "Every sub-subject must have exactly one rdfs:label." ;
    sh:message "Sub-subjects must have exactly one rdfs:label." ;
  ] ;

  sh:property [
    sh:path curric:isPartOf ;
    sh:class curric:Subject ;
    sh:minCount 1 ;
    sh:maxCount 1 ;
    sh:name "is part of" ;
    sh:description "Every sub-subject must be part of exactly one subject." ;
    sh:message "Sub-subjects must specify which subject they belong to." ;
  ] ;

  sh:property [
    sh:path curric:hasStrand ;
    sh:class curric:Strand ;
    sh:minCount 1 ;
    sh:severity sh:Warning ;
    sh:name "has strand" ;
    sh:description "Every sub-subject should relate to at least one strand." ;
    sh:message "Sub-subject should relate to at least one strand (WARNING)." ;
  ] ;

  sh:sparql [
    sh:severity sh:Warning ;
    sh:message "Sub-subject is not used in any scheme (WARNING - orphaned)" ;
    sh:select """
      PREFIX curric: <https://w3id.org/uk/curriculum/core/>
      SELECT $this WHERE {
        $this a curric:SubSubject .
        FILTER NOT EXISTS {
          ?scheme a curric:Scheme ;
                  curric:isPartOf $this .
        }
      }
    """ ;
  ] .

# ----------------------------------------------------------------------
# Shape: Scheme
# ----------------------------------------------------------------------

curricshapes:SchemeShape
  a sh:NodeShape ;
  sh:targetClass curric:Scheme ;

  sh:property [
    sh:path rdfs:label ;
    sh:datatype rdf:langString ;
    sh:minCount 1 ;
    sh:maxCount 1 ;
    sh:name "label" ;
    sh:description "Every scheme must have exactly one rdfs:label." ;
    sh:message "Schemes must have exactly one rdfs:label." ;
  ] ;

  sh:property [
    sh:path curric:isPartOf ;
    sh:class curric:SubSubject ;
    sh:minCount 1 ;
    sh:name "is part of" ;
    sh:description "Every scheme must be part of at least one sub-subject." ;
    sh:message "Schemes must specify which sub-subject(s) they belong to." ;
  ] ;

  sh:property [
    sh:path curric:hasKeyStage ;
    sh:class curric:KeyStage ;
    sh:minCount 1 ;
    sh:maxCount 1 ;
    sh:name "has key stage" ;
    sh:description "A scheme must cover exactly one key stage." ;
    sh:message "Schemes must specify exactly which key stage they cover." ;
  ] ;

  sh:property [
    sh:path curric:hasContentDescriptor ;
    sh:class curric:ContentDescriptor ;
    sh:minCount 1 ;
    sh:severity sh:Warning ;
    sh:name "has content descriptor" ;
    sh:description "Every scheme should relate to at least one content descriptor." ;
    sh:message "Scheme should relate to at least one content descriptor (WARNING)." ;
  ] ;

  sh:sparql [
    sh:message "Scheme's sub-subjects must all belong to the same subject" ;
    sh:select """
      PREFIX curric: <https://w3id.org/uk/curriculum/core/>
      SELECT $this WHERE {
        $this curric:isPartOf ?subsubject1 , ?subsubject2 .
        
        ?subsubject1 curric:isPartOf ?subject1 .
        ?subsubject2 curric:isPartOf ?subject2 .
        
        FILTER (?subsubject1 != ?subsubject2)
        FILTER (?subject1 != ?subject2)
      }
    """ ;
  ] .

# ----------------------------------------------------------------------
# Shape: ConceptScheme
# ----------------------------------------------------------------------

curricshapes:ConceptSchemeShape
  a sh:NodeShape ;
  sh:targetClass skos:ConceptScheme ;
  
  sh:property [
    sh:path skos:prefLabel ;
    sh:datatype rdf:langString ;
    sh:minCount 1 ;
    sh:maxCount 1 ;
    sh:name "preferred label" ;
    sh:description "Every concept scheme must have exactly one skos:prefLabel." ;
    sh:message "Concept schemes must have exactly one skos:prefLabel for SKOS taxonomy." ;
  ] .

# ----------------------------------------------------------------------
# Shape: Discipline
# ----------------------------------------------------------------------

curricshapes:DisciplineShape
  a sh:NodeShape ;
  sh:targetClass curric:Discipline ;

  sh:property [
    sh:path skos:prefLabel ;
    sh:datatype rdf:langString ;
    sh:minCount 1 ;
    sh:maxCount 1 ;
    sh:name "preferred label" ;
    sh:description "Every discipline must have exactly one skos:prefLabel." ;
    sh:message "Disciplines must have exactly one skos:prefLabel for SKOS taxonomy." ;
  ] ;

  sh:property [
    sh:path skos:inScheme ;
    sh:class skos:ConceptScheme ;
    sh:minCount 1 ;
    sh:maxCount 1 ;
    sh:name "in scheme" ;
    sh:description "Every discipline must be part of exactly one concept scheme." ;
    sh:message "Disciplines must specify which concept scheme they belong to." ;
  ] ;

  sh:property [
    sh:path skos:narrower ;
    sh:class curric:Strand ;
    sh:minCount 1 ;
    sh:name "narrower" ;
    sh:description "A discipline must have at least one child strand." ;
    sh:message "Disciplines must have at least one strand." ;
  ] .

# ----------------------------------------------------------------------
# Shape: Strand
# ----------------------------------------------------------------------

curricshapes:StrandShape
  a sh:NodeShape ;
  sh:targetClass curric:Strand ;

  sh:property [
    sh:path skos:prefLabel ;
    sh:datatype rdf:langString ;
    sh:minCount 1 ;
    sh:maxCount 1 ;
    sh:name "preferred label" ;
    sh:description "Every strand must have exactly one skos:prefLabel." ;
    sh:message "Strands must have exactly one skos:prefLabel for SKOS taxonomy." ;
  ] ;

  sh:property [
    sh:path skos:inScheme ;
    sh:class skos:ConceptScheme ;
    sh:minCount 1 ;
    sh:maxCount 1 ;
    sh:name "in scheme" ;
    sh:description "Every strand must be part of exactly one concept scheme." ;
    sh:message "Strands must specify which concept scheme they belong to." ;
  ] ;

  sh:property [
    sh:path skos:broader ;
    sh:class curric:Discipline ;
    sh:minCount 1 ;
    sh:maxCount 1 ;
    sh:name "broader" ;
    sh:description "Every strand must belong to exactly one discipline." ;
    sh:message "Strands must specify which discipline they belong to via skos:broader." ;
  ] ;

  sh:property [
    sh:path skos:narrower ;
    sh:class curric:SubStrand ;
    sh:minCount 1 ;
    sh:name "narrower" ;
    sh:description "A strand must have at least one child sub-strand." ;
    sh:message "Strands must have at least one sub-strand." ;
  ] ;

  sh:sparql [
    sh:severity sh:Warning ;
    sh:message "Strand is not referenced by any sub-subject (WARNING - orphaned)" ;
    sh:select """
      PREFIX curric: <https://w3id.org/uk/curriculum/core/>
      SELECT $this WHERE {
        $this a curric:Strand .
        FILTER NOT EXISTS {
          ?subsubject a curric:SubSubject ;
                      curric:hasStrand $this .
        }
      }
    """ ;
  ] ;

  sh:sparql [
    sh:severity sh:Warning ;
    sh:message "Strand is not referenced by any discipline via skos:narrower (WARNING - orphaned)" ;
    sh:select """
      PREFIX curric: <https://w3id.org/uk/curriculum/core/>
      PREFIX skos: <http://www.w3.org/2004/02/skos/core#>
      SELECT $this WHERE {
        $this a curric:Strand .
        FILTER NOT EXISTS {
          ?discipline a curric:Discipline ;
                      skos:narrower $this .
        }
      }
    """ ;
  ] .

# ----------------------------------------------------------------------
# Shape: SubStrand
# ----------------------------------------------------------------------

curricshapes:SubStrandShape
  a sh:NodeShape ;
  sh:targetClass curric:SubStrand ;

  sh:property [
    sh:path skos:prefLabel ;
    sh:datatype rdf:langString ;
    sh:minCount 1 ;
    sh:maxCount 1 ;
    sh:name "preferred label" ;
    sh:description "Every sub-strand must have exactly one skos:prefLabel." ;
    sh:message "Sub-strands must have exactly one skos:prefLabel for SKOS taxonomy." ;
  ] ;

  sh:property [
    sh:path skos:inScheme ;
    sh:class skos:ConceptScheme ;
    sh:minCount 1 ;
    sh:maxCount 1 ;
    sh:name "in scheme" ;
    sh:description "Every sub-strand must be part of exactly one concept scheme." ;
    sh:message "Sub-strands must specify which concept scheme they belong to." ;
  ] ;

  sh:property [
    sh:path skos:broader ;
    sh:class curric:Strand ;
    sh:minCount 1 ;
    sh:maxCount 1 ;
    sh:name "broader" ;
    sh:description "Every sub-strand must belong to exactly one strand." ;
    sh:message "Sub-strands must specify which strand they belong to via skos:broader." ;
  ] ;

  sh:property [
    sh:path skos:narrower ;
    sh:class curric:ContentDescriptor ;
    sh:minCount 1 ;
    sh:name "narrower" ;
    sh:description "A sub-strand must have at least one child content descriptor." ;
    sh:message "Sub-strands must have at least one content descriptor." ;
  ] ;

  sh:sparql [
    sh:severity sh:Warning ;
    sh:message "Sub-strand is not referenced by any strand via skos:narrower (WARNING - orphaned)" ;
    sh:select """
      PREFIX curric: <https://w3id.org/uk/curriculum/core/>
      PREFIX skos: <http://www.w3.org/2004/02/skos/core#>
      SELECT $this WHERE {
        $this a curric:SubStrand .
        FILTER NOT EXISTS {
          ?strand a curric:Strand ;
                  skos:narrower $this .
        }
      }
    """ ;
  ] .

# ----------------------------------------------------------------------
# Shape: ContentDescriptor
# ----------------------------------------------------------------------

curricshapes:ContentDescriptorShape
  a sh:NodeShape ;
  sh:targetClass curric:ContentDescriptor ;

  sh:property [
    sh:path skos:prefLabel ;
    sh:datatype rdf:langString ;
    sh:minCount 1 ;
    sh:maxCount 1 ;
    sh:name "preferred label" ;
    sh:description "Every content descriptor must have exactly one skos:prefLabel." ;
    sh:message "Content descriptors must have exactly one skos:prefLabel for SKOS taxonomy." ;
  ] ;

  sh:property [
    sh:path skos:inScheme ;
    sh:class skos:ConceptScheme ;
    sh:minCount 1 ;
    sh:maxCount 1 ;
    sh:name "in scheme" ;
    sh:description "Every content descriptor must be part of exactly one concept scheme." ;
    sh:message "Content descriptors must specify which concept scheme they belong to." ;
  ] ;

  sh:property [
    sh:path skos:broader ;
    sh:class curric:SubStrand ;
    sh:minCount 1 ;
    sh:maxCount 1 ;
    sh:name "broader" ;
    sh:description "Every content descriptor must belong to exactly one sub-strand." ;
    sh:message "Content descriptors must specify which sub-strand they belong to via skos:broader." ;
  ] ;

  sh:sparql [
    sh:severity sh:Warning ;
    sh:message "Content descriptor is not referenced by any sub-strand via skos:narrower (WARNING - orphaned)" ;
    sh:select """
      PREFIX curric: <https://w3id.org/uk/curriculum/core/>
      PREFIX skos: <http://www.w3.org/2004/02/skos/core#>
      SELECT $this WHERE {
        $this a curric:ContentDescriptor .
        FILTER NOT EXISTS {
          ?substrand a curric:SubStrand ;
                     skos:narrower $this .
        }
      }
    """ ;
  ] ;

  sh:sparql [
    sh:severity sh:Warning ;
    sh:message "Content descriptor is not used in any scheme (WARNING - orphaned)" ;
    sh:select """
      PREFIX curric: <https://w3id.org/uk/curriculum/core/>
      SELECT $this WHERE {
        $this a curric:ContentDescriptor .
        FILTER NOT EXISTS {
          ?scheme a curric:Scheme ;
                  curric:hasContentDescriptor $this .
        }
      }
    """ ;
  ] .

# ----------------------------------------------------------------------
# Shape: ContentSubDescriptor
# ----------------------------------------------------------------------

curricshapes:ContentSubDescriptorShape
  a sh:NodeShape ;
  sh:targetClass curric:ContentSubDescriptor ;

  sh:property [
    sh:path skos:prefLabel ;
    sh:datatype rdf:langString ;
    sh:minCount 1 ;
    sh:maxCount 1 ;
    sh:name "preferred label" ;
    sh:description "Every content sub-descriptor must have exactly one skos:prefLabel." ;
    sh:message "Content sub-descriptors must have exactly one skos:prefLabel for SKOS taxonomy." ;
  ] ;

  sh:property [
    sh:path skos:inScheme ;
    sh:class skos:ConceptScheme ;
    sh:minCount 1 ;
    sh:maxCount 1 ;
    sh:name "in scheme" ;
    sh:description "Every content sub-descriptor must be part of exactly one concept scheme." ;
    sh:message "Content sub-descriptors must specify which concept scheme they belong to." ;
  ] ;

  sh:property [
    sh:path skos:broader ;
    sh:class curric:ContentDescriptor ;
    sh:minCount 1 ;
    sh:maxCount 1 ;
    sh:name "broader" ;
    sh:description "Every content sub-descriptor must belong to exactly one content descriptor." ;
    sh:message "Content sub-descriptors must specify which content descriptor they belong to via skos:broader." ;
  ] ;

  sh:property [
    sh:path curric:example ;
    sh:datatype rdf:langString ;
    sh:name "example" ;
    sh:description "A content sub-descriptor may have zero or more text examples." ;
  ] ;

  sh:property [
    sh:path curric:exampleURL ;
    sh:datatype xsd:anyURI ;
    sh:name "example URL" ;
    sh:description "A content sub-descriptor may have zero or more URL examples." ;
  ] ;

  sh:sparql [
    sh:severity sh:Warning ;
    sh:message "Content sub-descriptor is not referenced by any content descriptor via skos:narrower (WARNING - orphaned)" ;
    sh:select """
      PREFIX curric: <https://w3id.org/uk/curriculum/core/>
      PREFIX skos: <http://www.w3.org/2004/02/skos/core#>
      SELECT $this WHERE {
        $this a curric:ContentSubDescriptor .
        FILTER NOT EXISTS {
          ?descriptor a curric:ContentDescriptor ;
                      skos:narrower $this .
        }
      }
    """ ;
  ] .

# ----------------------------------------------------------------------
# Shape: Theme
# ----------------------------------------------------------------------

curricshapes:ThemeShape
  a sh:NodeShape ;
  sh:targetClass curric:Theme ;

  sh:property [
    sh:path skos:prefLabel ;
    sh:datatype rdf:langString ;
    sh:minCount 1 ;
    sh:maxCount 1 ;
    sh:name "preferred label" ;
    sh:description "Every theme must have exactly one skos:prefLabel." ;
    sh:message "Themes must have exactly one skos:prefLabel for SKOS taxonomy." ;
  ] ;

  sh:property [
    sh:path skos:definition ;
    sh:datatype rdf:langString ;
    sh:minCount 1 ;
    sh:name "definition" ;
    sh:description "Every theme must have at least one definition." ;
    sh:message "Themes must have a skos:definition explaining their purpose." ;
  ] ;

  sh:property [
    sh:path skos:inScheme ;
    sh:class skos:ConceptScheme ;
    sh:minCount 1 ;
    sh:maxCount 1 ;
    sh:name "in scheme" ;
    sh:description "Every theme must be part of exactly one concept scheme." ;
    sh:message "Themes must specify which concept scheme they belong to." ;
  ] ;

  sh:sparql [
    sh:severity sh:Warning ;
    sh:message "Theme is not related to any content (WARNING - orphaned)" ;
    sh:select """
      PREFIX curric: <https://w3id.org/uk/curriculum/core/>
      PREFIX skos: <http://www.w3.org/2004/02/skos/core#>
      SELECT $this WHERE {
        $this a curric:Theme .
        FILTER NOT EXISTS {
          {
            ?content a curric:ContentDescriptor ;
                     skos:related $this .
          } UNION {
            $this skos:related ?content .
            ?content a curric:ContentDescriptor .
          }
        }
      }
    """ ;
  ] .